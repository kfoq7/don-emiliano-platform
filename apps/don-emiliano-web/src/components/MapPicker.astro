---
interface Props {
  lat?: number
  lng?: number
  name?: string
  height?: string
  zoom?: number
}

// Setting by default the current restaurant
const {
  lat = -11.95118,
  lng = -77.0509283,
  name = 'location',
  height = '500px',
  zoom = 17,
} = Astro.props

const uniqueId = `map-${Math.random().toString(36).slice(2, 9)}`
---

<div id="map-container" class="w-full px-8 flex flex-col items-center" data-unique-id={uniqueId}>
  <div class="mt-4 mx-6 gap-2 flex flex-col md:flex-none items-center w-full max-w-md">
    <div class="w-full relative">
      <input
        id="location-search"
        aria-label="Search for a location in Lima, Peru"
        type="text"
        placeholder="Buscar direcciÃ³n en Lima..."
        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-primary/80 focus:outline-none"
      />
      <div
        id="search-results"
        class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
      >
      </div>
    </div>

    <p class="mt-2 text-sm text-gray-600">
      Lat: <span class="lat-display">{lat.toFixed(6)}</span>
      , Lng: <span class="lng-display">
        {lng.toFixed(6)}
      </span>
    </p>
  </div>

  <div
    id="map-picker"
    class="map-wrapper rounded-lg overflow-hidden border mx-5 z-9"
    aria-label="Interactive map to get the user location"
    style={`width: 100%; height: ${height};`}
  >
  </div>

  <input aria-hidden="true" type="hidden" name={`${name}-lat`} class="lat-input" value={lat} />
  <input aria-hidden="true" type="hidden" name={`${name}-lng`} class="lng-input" value={lng} />
</div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Leaflet JS -->
<script
  is:inline
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script>
  import { location } from '@/stores/location'
  import { debounce } from '@/lib/utils/debounce'

  const L = window.L

  // Fix Leaflet default icon issue
  const fixLeafletIcons = () => {
    delete (L.Icon.Default.prototype as any)._getIconUrl
    L.Icon.Default.mergeOptions({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    })
  }

  // Search location using Nominatim API
  async function searchLocation(query: string): Promise<any[]> {
    if (!query || query.trim().length < 3) return []

    try {
      // Lima, Peru bounding box
      const minlon = -77.2
      const minlat = -12.3
      const maxlon = -76.7
      const maxlat = -11.7

      const url = new URL('https://nominatim.openstreetmap.org/search')
      url.searchParams.set('q', `${query}, Lima, Peru, Comas`)
      url.searchParams.set('format', 'json')
      url.searchParams.set('limit', '5')
      url.searchParams.set('countrycodes', 'pe')
      url.searchParams.set('bounded', '1')
      url.searchParams.set('viewbox', `${minlon},${maxlat},${maxlon},${minlat}`)
      console.log(url.toString())

      const response = await fetch(url.toString(), {
        headers: {
          'Accept-Language': 'es',
        },
      })

      if (!response.ok) throw new Error('Search failed')

      return await response.json()
    } catch (error) {
      console.error('Error searching location:', error)
      return []
    }
  }

  const initializeMap = (container: Element) => {
    const wrapper = container.querySelector('#map-picker') as HTMLElement
    if (!wrapper) return

    const lat = parseFloat(container.getAttribute('data-lat') || '-34.397')
    const lng = parseFloat(container.getAttribute('data-lng') || '150.644')
    const zoom = parseInt(container.getAttribute('data-zoom') || '13')

    // Initialize map
    try {
      const map = L.map(wrapper).setView([lat, lng], zoom)

      // Remove leaflet attribution
      map.attributionControl.setPrefix('')

      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
      }).addTo(map)

      // Set the local Restaturant
      const restaurantIcon = L.divIcon({
        html: `
          <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="orange"><path d="M841-518v318q0 33-23.5 56.5T761-120H201q-33 0-56.5-23.5T121-200v-318q-23-21-35.5-54t-.5-72l42-136q8-26 28.5-43t47.5-17h556q27 0 47 16.5t29 43.5l42 136q12 39-.5 71T841-518Zm-272-42q27 0 41-18.5t11-41.5l-22-140h-78v148q0 21 14 36.5t34 15.5Zm-180 0q23 0 37.5-15.5T441-612v-148h-78l-22 140q-4 24 10.5 42t37.5 18Zm-178 0q18 0 31.5-13t16.5-33l22-154h-78l-40 134q-6 20 6.5 43t41.5 23Zm540 0q29 0 42-23t6-43l-42-134h-76l22 154q3 20 16.5 33t31.5 13ZM201-200h560v-282q-5 2-6.5 2H751q-27 0-47.5-9T663-518q-18 18-41 28t-49 10q-27 0-50.5-10T481-518q-17 18-39.5 28T393-480q-29 0-52.5-10T299-518q-21 21-41.5 29.5T211-480h-4.5q-2.5 0-5.5-2v282Zm560 0H201h560Z"/></svg>`,
        iconSize: [28, 28],
        iconAnchor: [12, 12],
        className: 'restaurant-icon-marker',
      })

      // Load Restaturant Icon
      L.marker([lat, lng], { icon: restaurantIcon }).addTo(map)

      // Add initial marker if coordinates are not default
      let marker: L.Marker | null = null
      marker = L.marker([lat, lng]).addTo(map)

      // Get form inputs and displays
      const latInput = container.querySelector('.lat-input') as HTMLInputElement
      const lngInput = container.querySelector('.lng-input') as HTMLInputElement
      const latDisplay = container.querySelector('.lat-display')
      const lngDisplay = container.querySelector('.lng-display')
      const searchInput = container.querySelector('#location-search') as HTMLInputElement
      const searchResults = container.querySelector('#search-results') as HTMLDivElement
      const addressInput = container.querySelectorAll('input[type="text"]')[1] as HTMLInputElement

      // Update location helper
      const updateLocation = (newLat: number, newLng: number, displayName?: string) => {
        // Update or create marker
        if (marker) {
          marker.setLatLng([newLat, newLng])
        } else {
          marker = L.marker([newLat, newLng]).addTo(map)
        }

        // Center map on new location
        map.setView([newLat, newLng], 17)

        // Update hidden inputs
        if (latInput) latInput.value = newLat.toString()
        if (lngInput) lngInput.value = newLng.toString()

        const latFixed = newLat.toFixed(6)
        const lngFixed = newLng.toFixed(6)

        // Update display
        if (latDisplay) latDisplay.textContent = latFixed
        if (lngDisplay) lngDisplay.textContent = lngFixed

        // Update address input if display name is provided
        if (displayName && addressInput) {
          addressInput.value = displayName
        }

        // Update local state coord
        location.set({ lat: latFixed, lng: lngFixed })

        container.dispatchEvent(
          new CustomEvent('location-change', {
            detail: { latitude: newLat, longitude: newLng },
            bubbles: true,
          }),
        )
      }

      // Handle map clicks
      map.on('click', (e: L.LeafletMouseEvent) => {
        updateLocation(e.latlng.lat, e.latlng.lng)
      })

      // Search functionality with debounce
      const handleSearch = debounce(async (query: string) => {
        if (!searchResults) return

        const results = await searchLocation(query)

        if (results.length === 0) {
          searchResults.innerHTML =
            '<div class="p-3 text-gray-500 text-sm">No se encontraron resultados</div>'
          searchResults.classList.remove('hidden')
          return
        }

        searchResults.innerHTML = results
          .map(
            result => `
          <button
            type="button"
            class="search-result-item w-full text-left p-3 hover:bg-gray-100 border-b last:border-b-0 transition-colors"
            data-lat="${result.lat}"
            data-lon="${result.lon}"
            data-display-name="${result.display_name}"
          >
            <div class="font-medium text-sm">${result.display_name}</div>
          </button>
        `,
          )
          .join('')

        searchResults.classList.remove('hidden')

        // Add click handlers to results
        searchResults.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            const resultLat = parseFloat(item.getAttribute('data-lat') || '0')
            const resultLon = parseFloat(item.getAttribute('data-lon') || '0')
            const displayName = item.getAttribute('data-display-name') || ''

            updateLocation(resultLat, resultLon, displayName)

            // Update search input and hide results
            if (searchInput) searchInput.value = displayName
            searchResults.classList.add('hidden')
          })
        })
      }, 500)

      // Search input event listener
      if (searchInput) {
        searchInput.addEventListener('input', e => {
          const query = (e.target as HTMLInputElement).value
          if (query.trim().length >= 3) {
            handleSearch(query)
          } else {
            searchResults?.classList.add('hidden')
          }
        })

        // Close results when clicking outside
        document.addEventListener('click', e => {
          if (
            !searchInput.contains(e.target as Node) &&
            !searchResults?.contains(e.target as Node)
          ) {
            searchResults?.classList.add('hidden')
          }
        })
      }

      // Store map instance on container for external access
      ;(container as any).__leafletMap = map
    } catch (error) {
      console.log('Initialize map error.')
    }
  }

  // Initialize on load and for dynamic content
  const initialize = () => {
    fixLeafletIcons()
    const mapContainer = document.querySelector('#map-container')
    if (!mapContainer) return
    initializeMap(mapContainer)
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize)
  } else {
    initialize()
  }
</script>

<script is:inline define:vars={{ lat, lng, zoom, uniqueId }}>
  // Set data attributes for this specific instance
  const container = document.querySelector(`[data-unique-id="${uniqueId}"]`)
  if (container) {
    container.setAttribute('data-lat', lat.toString())
    container.setAttribute('data-lng', lng.toString())
    container.setAttribute('data-zoom', zoom.toString())
  }
</script>
